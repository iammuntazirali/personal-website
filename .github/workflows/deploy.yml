name: Deploy Laravel Portfolio

# Run this workflow whenever you push to main
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Pull code from GitHub
      - uses: actions/checkout@v3

      # Set up PHP 8.4 (for Laravel)
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.4
          extensions: mbstring, bcmath, curl, xml

      # Install Composer dependencies
      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      # Set up Node and build Vite assets
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install NPM packages
        run: npm install

      - name: Build assets
        run: npm run build

      # Deploy everything except public/ to parent folder
      - name: Deploy Laravel backend files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          password: ${{ secrets.HOSTINGER_PASS }}
          protocol: ftps
          port: 21
          local-dir: ./            # whole repo
          exclude: |
            public/**       
            node_modules/**
            .git/**
            tests/**
          server-dir: ../          # parent of public_html

      # Deploy only public/ to public_html
      - name: Deploy public folder
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          password: ${{ secrets.HOSTINGER_PASS }}
          protocol: ftps
          port: 21
          local-dir: ./public
          server-dir: /public_html/ 